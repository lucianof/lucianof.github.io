<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>

      <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQHtZ8TjYBNIVjWMit1OieBVq_830veb0&sensor=false">
    </script>

    <script src="./roads_processed_frame.js" type="text/javascript"></script>
    <script type="text/javascript">


        //
        // ROADS
        //

        // /pathStr = "(47.38625282167463,8.414204047937782), (47.38557873038006,8.414449544573937), (47.38473346199245,8.414881491993699), (47.38372707479582,8.415465803790074), (47.38295053801575,8.415824735518353), (47.38187243897928,8.41617621666587), (47.38032439456115,8.416634241118302), (47.37956648423299,8.416956292471802), (47.37862938743746,8.417427541705091), (47.37680567153109,8.418448457534204), (47.376005665421616,8.418837564114575), (47.37500114087018,8.419199289810642), (47.374145814198535,8.419485950905516), (47.37332103490802,8.41973182007071), (47.372466267029935,8.420010099262225), (47.37189573880797,8.420226166104365), (47.37126150812048,8.420487867753682), (47.37053675287672,8.420895414521443), (47.370145969915676,8.421099374169842), (47.36972240439927,8.421357164264258), (47.36933087638015,8.421667667217575), (47.36782027113036,8.422987165070783), (47.36748182849918,8.423241229874817), (47.36707614437661,8.423495108414333), (47.366221003969486,8.42389930242075), (47.3657732240656,8.424088174643103), (47.36515706103646,8.424233274703472), (47.364538476568576,8.424223030154922), (47.36382359334432,8.424052784384477), (47.363106847474874,8.423833364780993), (47.36239680712812,8.423595132461081), (47.36089775027851,8.422972077644737), (47.36068540872675,8.422897199308064), (47.36004056096168,8.422697337479084)";

        // This array should contain the roads data
        //
        roadSegmentsByTime = [
            [
                {
                    "id": 2,
                    "start": [47.35650163792198, 8.4210205078125],
                    "end": [47.3403058599989, 8.444023132324219],
                    "path":"(47.38625282167463,8.414204047937782), (47.38557873038006,8.414449544573937), (47.38473346199245,8.414881491993699), (47.38372707479582,8.415465803790074), (47.38295053801575,8.415824735518353), (47.38187243897928,8.41617621666587), (47.38032439456115,8.416634241118302), (47.37956648423299,8.416956292471802), (47.37862938743746,8.417427541705091), (47.37680567153109,8.418448457534204), (47.376005665421616,8.418837564114575), (47.37500114087018,8.419199289810642), (47.374145814198535,8.419485950905516), (47.37332103490802,8.41973182007071), (47.372466267029935,8.420010099262225), (47.37189573880797,8.420226166104365), (47.37126150812048,8.420487867753682), (47.37053675287672,8.420895414521443), (47.370145969915676,8.421099374169842), (47.36972240439927,8.421357164264258), (47.36933087638015,8.421667667217575), (47.36782027113036,8.422987165070783), (47.36748182849918,8.423241229874817), (47.36707614437661,8.423495108414333), (47.366221003969486,8.42389930242075), (47.3657732240656,8.424088174643103), (47.36515706103646,8.424233274703472), (47.364538476568576,8.424223030154922), (47.36382359334432,8.424052784384477), (47.363106847474874,8.423833364780993), (47.36239680712812,8.423595132461081), (47.36089775027851,8.422972077644737), (47.36068540872675,8.422897199308064), (47.36004056096168,8.422697337479084)",
                    "speed": 40,
                    "timestamp": 880203030
                },
                {
                    "id": 1,
                    "start": [47.3403058599989, 8.444023132324219],
                    "end": [47.35650163792198, 8.4210205078125],
                    "path":"(47.36004056096168,8.422697337479084), (47.36068540872675,8.422897199308064), (47.36089775027851,8.422972077644737), (47.36239680712812,8.423595132461081), (47.363106847474874,8.423833364780993), (47.36382359334432,8.424052784384477), (47.364538476568576,8.424223030154922), (47.36515706103646,8.424233274703472), (47.3657732240656,8.424088174643103), (47.366221003969486,8.42389930242075), (47.36707614437661,8.423495108414333), (47.36748182849918,8.423241229874817), (47.36782027113036,8.422987165070783), (47.36933087638015,8.421667667217575), (47.36972240439927,8.421357164264258), (47.370145969915676,8.421099374169842), (47.37053675287672,8.420895414521443), (47.37126150812048,8.420487867753682), (47.37189573880797,8.420226166104365), (47.372466267029935,8.420010099262225), (47.37332103490802,8.41973182007071), (47.374145814198535,8.419485950905516), (47.37500114087018,8.419199289810642), (47.376005665421616,8.418837564114575), (47.37680567153109,8.418448457534204), (47.37862938743746,8.417427541705091), (47.37956648423299,8.416956292471802), (47.38032439456115,8.416634241118302), (47.38187243897928,8.41617621666587), (47.38295053801575,8.415824735518353), (47.38372707479582,8.415465803790074), (47.38473346199245,8.414881491993699), (47.38557873038006,8.414449544573937), (47.38625282167463,8.414204047937782)",
                    "speed": 80,
                    "timestamp": 880203030
                }
            ],
            [
                {
                    "id": 2,
                    "start": [47.35650163792198, 8.4210205078125],
                    "end": [47.3403058599989, 8.444023132324219],
                    "path":"(47.38625282167463,8.414204047937782), (47.38557873038006,8.414449544573937), (47.38473346199245,8.414881491993699), (47.38372707479582,8.415465803790074), (47.38295053801575,8.415824735518353), (47.38187243897928,8.41617621666587), (47.38032439456115,8.416634241118302), (47.37956648423299,8.416956292471802), (47.37862938743746,8.417427541705091), (47.37680567153109,8.418448457534204), (47.376005665421616,8.418837564114575), (47.37500114087018,8.419199289810642), (47.374145814198535,8.419485950905516), (47.37332103490802,8.41973182007071), (47.372466267029935,8.420010099262225), (47.37189573880797,8.420226166104365), (47.37126150812048,8.420487867753682), (47.37053675287672,8.420895414521443), (47.370145969915676,8.421099374169842), (47.36972240439927,8.421357164264258), (47.36933087638015,8.421667667217575), (47.36782027113036,8.422987165070783), (47.36748182849918,8.423241229874817), (47.36707614437661,8.423495108414333), (47.366221003969486,8.42389930242075), (47.3657732240656,8.424088174643103), (47.36515706103646,8.424233274703472), (47.364538476568576,8.424223030154922), (47.36382359334432,8.424052784384477), (47.363106847474874,8.423833364780993), (47.36239680712812,8.423595132461081), (47.36089775027851,8.422972077644737), (47.36068540872675,8.422897199308064), (47.36004056096168,8.422697337479084)",
                    "speed": 80,
                    "timestamp": 880203030
                },
                {
                    "id": 1,
                    "start": [47.3403058599989, 8.444023132324219],
                    "end": [47.35650163792198, 8.4210205078125],
                    "path":"(47.36004056096168,8.422697337479084), (47.36068540872675,8.422897199308064), (47.36089775027851,8.422972077644737), (47.36239680712812,8.423595132461081), (47.363106847474874,8.423833364780993), (47.36382359334432,8.424052784384477), (47.364538476568576,8.424223030154922), (47.36515706103646,8.424233274703472), (47.3657732240656,8.424088174643103), (47.366221003969486,8.42389930242075), (47.36707614437661,8.423495108414333), (47.36748182849918,8.423241229874817), (47.36782027113036,8.422987165070783), (47.36933087638015,8.421667667217575), (47.36972240439927,8.421357164264258), (47.370145969915676,8.421099374169842), (47.37053675287672,8.420895414521443), (47.37126150812048,8.420487867753682), (47.37189573880797,8.420226166104365), (47.372466267029935,8.420010099262225), (47.37332103490802,8.41973182007071), (47.374145814198535,8.419485950905516), (47.37500114087018,8.419199289810642), (47.376005665421616,8.418837564114575), (47.37680567153109,8.418448457534204), (47.37862938743746,8.417427541705091), (47.37956648423299,8.416956292471802), (47.38032439456115,8.416634241118302), (47.38187243897928,8.41617621666587), (47.38295053801575,8.415824735518353), (47.38372707479582,8.415465803790074), (47.38473346199245,8.414881491993699), (47.38557873038006,8.414449544573937), (47.38625282167463,8.414204047937782)",
                    "speed": 20,
                    "timestamp": 880203030
                }
            ]
        ];

        roadSegmentsByTime = [roads];

        roads2 = [];
        for (i=0;i<roads.length;i++){
            roads2.push({
                id: roads[i].id,
                path: roads[i].path,
                start: roads[i].start,
                end: roads[i].end,
                speed: Math.round(Math.random()*100)
            });
        }

        roadSegmentsByTime.push(roads2);



        var allOverlays = [];
        var zoom = 11;
        var oldZoom = 11;



        function initialize() {

            // Setup maps and driving directions service
            //
            var mapOptions = {
                center: new google.maps.LatLng(46.8526782485311, 8.3111572265625),
                zoom: 8,
                mapTypeId: google.maps.MapTypeId.SATELLITE
            };
            var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
            var service = new google.maps.DirectionsService();



            // Adding some stuff that's missing from google maps api
            //
            google.maps.LatLng.prototype.kmTo = function(a){
                var e = Math, ra = e.PI/180;
                var b = this.lat() * ra, c = a.lat() * ra, d = b - c;
                var g = this.lng() * ra - a.lng() * ra;
                var f = 2 * e.asin(e.sqrt(e.pow(e.sin(d/2), 2) + e.cos(b) * e.cos
                        (c) * e.pow(e.sin(g/2), 2)));
                return f * 6378.137;
            };
            google.maps.Polyline.prototype.inKm = function(n){
                var a = this.getPath(n), len = a.getLength(), dist = 0;
                for(var i=0; i<len-1; i++){
                    dist += a.getAt(i).kmTo(a.getAt(i+1));
                }
                return dist;
            };



            //
            //
            //
            var parseStringToPath = function(pathStr){
                pathArr = pathStr.split(", ");

                pathGoogle = [];

                for (i=0;i<pathArr.length;i++){

                    pathArr[i] = pathArr[i].replace("(","");
                    pathArr[i] = pathArr[i].replace(")","");
                    pathParts = pathArr[i].split(",");

                    x = parseFloat(pathParts[0]);
                    y = parseFloat(pathParts[1]);

                    pathGoogle.push(new google.maps.LatLng(x,y));
                }

                return pathGoogle;
            };



            // Shift the polyline perpendicularly
            //
            var shiftPath = function(path){

                xLat = path[0].lat();
                xLon = path[0].lng();
                yLat = path[path.length-1].lat();
                yLon = path[path.length-1].lng();

                step = 0.0030; // ~ degrees in 1 meter;

                dx = step * (yLat - xLat) / Math.sqrt( Math.pow((yLon-xLon),2)+Math.pow((yLat-xLat),2));
                dy = step * (yLon - xLon) / Math.sqrt( Math.pow((yLon-xLon),2)+Math.pow((yLat-xLat),2));

                newPath = [];
                for(i=0;i<path.length;i++){
                    newPath.push(new google.maps.LatLng(path[i].lat()+dy,path[i].lng()-dx));
                }

                return newPath;
            };



            // Shift and draw polyline
            //
            var drawShiftedPolyline = function(path, color){
                drawPolyline(shiftPath(path),color);
            };



            // Drawing polyline
            //
            var drawPolyline = function(path, color){

                var poly = new google.maps.Polyline({
                    path: path,
                    strokeColor: color,
                    strokeOpacity: 1.0,
                    strokeWeight: 5,
                    map: map
                });

                allOverlays.push(poly);
            };



            // Drawing the straight line
            //
            var drawLine = function(start,end, color){

                var path = [
                    new google.maps.LatLng(start[0], start[1]),
                    new google.maps.LatLng(end[0], end[1])
                ];

                drawShiftedPolyline(path,color);
            };



            // Draw the road segment, one of all
            //
            var getRoadColor = function(speed){

                if (speed <= 30)
                    color = "#cc0000";
                else if ((speed > 30) && (speed < 80))
                    color = "#ffee00";
                else
                    color = "#00cc00";

                return color;
            };



            // Drawing all the segments
            //
            var drawRoads = function(roadSegments){

                for (var l=0;l<roadSegments.length;l++){

                    color = getRoadColor(roadSegments[l].speed);

                   if ( (zoom < 9) || ( (typeof roadSegments[l].path == 'undefined') && (roadSegments[l].path == '') ) )
                        drawLine(roadSegments[l].start,roadSegments[l].end,color);
                   else
                        drawShiftedPolyline(parseStringToPath(roadSegments[l].path),color);
                }

            };



            // Utility that shows click geo coordinates
            //
            google.maps.event.addListener(map, "click", function(event) {
                var lat = event.latLng.lat();
                var lng = event.latLng.lng();

                // populate yor box/field with lat, lng

                //alert("["+lat+", "+lng+"]");
                $("#coord-box").html("["+lat+", "+lng+"]");
            });



            // Zoom guard dog
            //
            google.maps.event.addListener(map, "zoom_changed", function(event) {

                if (map.getZoom() !== zoom){
                    zoom = map.getZoom();
                    $("#coord-box").html(map.getZoom());
                    scrollBox.trigger("scroll");
                }



                //alert("["+lat+", "+lng+"]");

            });



            //
            // / ROADS
            //





            // Initial frame of animation
            //
            drawRoads(roadSegmentsByTime[0]);



            // Animation setup and movement
            //
            var scrollBox = $('#scroll-box');
            var frameCount = roadSegmentsByTime.length;
            var currentFrame = -1;


            scrollBox.scroll(function(e){

                var scrollPosition = scrollBox.scrollTop() / ($('#too-long-box').height()-scrollBox.height()) * 100;
                $("#coord-box").html(scrollPosition);

                var frameNumber = Math.round((scrollPosition / 100 )*(frameCount-1));

                if ((currentFrame !== frameNumber) || (zoom !== oldZoom) ){

                    if (currentFrame == frameNumber)
                        oldZoom = zoom;

                    // Copy old shapes to oldOverlays
                    oldOverlays = [];
                    if (allOverlays.length > 0){
                        while(allOverlays[0])
                        {
                            oldOverlays.push(allOverlays.pop());
                        }
                    }

                    // Draw new shapes
                    currentFrame = frameNumber;
                    console.log("Drawing frame "+frameNumber);
                    drawRoads(roadSegmentsByTime[frameNumber]);

                    // Kill old shapes
                    while(oldOverlays[0])
                    {
                        oldOverlays.pop().setMap(null);
                    }
                }


            });


        }
        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <div id="coord-box" style="position: absolute; bottom: 10px; left: 10px; background: white; padding:5px;"></div>
    <div id="scroll-box" style="position: absolute; right: 10px; top: 0; height: 95%;width: 30px; overflow-y:scroll;">
        <div id="too-long-box" style="width:1px;height: 5000px"></div>
    </div>


  </body>
</html>
